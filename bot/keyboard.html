<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
    <title>Bot 5</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    
</head>
<body>
    <p style="margin-bottom: 3em"></p>
    <div class="container h-100">
		<div class="row">
			<div class="col-md-8 offset-md-1">
                <h1>Создание клавиатуры и БД подписчиков</h1>
                <br>
                Стандартная клавиатура выглядит следующим образом:
                <br>
                <img src="img/image15.png" width="500px" height="auto">
                <br>
                Кнопки бывают следующих типов:
<br>
Text - отправляет на сервер текстовое сообщение указанным в label
<br>
Location по нажатию на кнопку отправляет местоположение в беседу
<br>
VK Рау – открывает окно оплаты с определенными условиями
<br>
VK Apps - открывает указанное приложение VK
<br>
Структура данных для клавиатуры, выглядит следующим образом.
                <br>
                <img src="img/image16.png" width="500px" height="auto">
                <br>

                В первой паре передается настройка, сохраняется ли эта клавиатура на одно действие или до тех пор, пока не будет передана следующая ("one_time": false). Далее в массиве передаются кнопки и их типы. Чтобы включить клавиатуру в боте необходимо передать параметр keyboard, в методе message.send.
                <br>
                <br>
                Основная цель - предоставить пользователю возможность выбрать группу (у нас будут Друзья, Одноклассники и Программисты), сохранять выбор в базу данных, а также от лица админа отправлять сообщения всем пользователям с определенной группой. Получается своеобразный новостной канал
                <br>
                <br>
                Но для начала нужно включить возможность создавать клавиатуру в настройках бота.
                Переходим в настройки бота сообщения > настройки для бота. Включаем возможности бота, тут же мы можем добавить кнопку Начать, поставим галочку на этом пункте, она нам еще пригодится. 
                <br>
                <img src="img/image17.png" width="500px" height="auto">
                <br>
                Данная настройка добавляет кнопку начать, если у пользователя и бота раньше не было сообщений. При нажатии на тестовые кнопки, в тело запроса добавляется строка 'payload': '{"button":"1"}", что совпадает с объявлением payload в массиве кнопок. Это поможет нам разделить кнопки от идентичного текста, написанного пользователями.
                <br>
                <br>
                <h6>Задание 1. Обработка кнопки начать</h6>
                Пишем функцию для обработки. 
                <br>
                <img src="img/image18.png" width="500px" height="auto">
                <br>
                В файле urls.py нужно поменять вызываемую функцию для бота (вместо index написать get_message)
                <br>
                <br>
                Теперь нужно написать функцию start, которая вызывается, если в запросе присутсвует кнопка начать
                <br>
                <img src="img/image19.png" width="800px" height="auto">
                <br>
                Эта функция отправляет сообщение пользователю и передает клавиатуру из трех кнопок
                <br>
                <br>
                <h6>Задание 2. Обработка обычных сообщений</h6>
                В случае если пользователь не нажимает кнопки, а просто пишет текст функция должна обрабатывать код нашей старой функции. Немного поправим ее. Уберем проверку на новые сообщения и уберем лишние табуляции. А также переименуем ее в talk() и убираем @csrf
                <br>
                <img src="img/image20.png" width="800px" height="auto">
                <br>
                А в функции get_message добавим else, в котором и будет вызываться функция talk
                <br>
                <img src="img/image21.png" width="500px" height="auto">
                <br>
                <br>
                <h6>Задание 3. Создание базы данных</h6>
                В уже существующей БД (database.sqlite) нам нужно создать еще две таблички:
                <br>
                <ol>
                    <li>
                        Таблица groups со следующими атрибутами:
                        <ul>
                            <li>id - целое число, нужно дописать также primary key autoincrement</li>
                            <li>group_name - текст</li>
                        </ul>
                    </li>
                    <li>
                        Таблица user со следующими атрибутами:
                        <ul>
                            <li>id - целое число, нужно дописать также primary key</li>
                            <li>chat_id - целое число</li>
                            <li>id_group - целое число</li>
                            <li>Добавляем foreign key атрибута id_group в таблицу groups (id)</li>
                        </ul>
                    </li>
                </ol>
                Теперь нужно добавить записи в таблицу groups
                <ul>
                    <li> (1, 'friends')</li>
                    <li> (2, 'classmates')</li>
                    <li> (3, 'programmers')</li>
                </ul>
                <h6>Задание 4. Создание функции для обработки запросов в БД</h6>
                После успешного создания новых таблиц, закомментируйте код, который их создавал и добавлял значения.
                <br>
                Напишем функцию, которая будет добавлять значения в таблицу user. Основная идея: пользователь выбирает группу с помощью кнопок, а мы добавляем его в таблицу user. В целом код похож на добавление значений в таблицу phrases
                <br>
                <img src="img/image22.png" width="800px" height="auto">
                <br>
                <br>
                <h6>Задание 5. Использование созданной функции</h6>
                Возвращаемся к нашему фалу views.py и используем созданные нами функции. В случае, если кнопка не start, значит вызываем метод add_member().
                
                <br>
                <img src="img/image23.png" width="500px" height="auto">
                <br>
            </div>
        </div>
    </div>
    <script> var name = 'qList5'; </script>
    <script src="script.js"></script>
</body>
</html>
